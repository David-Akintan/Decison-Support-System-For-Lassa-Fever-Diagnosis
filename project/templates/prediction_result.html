<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hybrid GNN Results - Lassa Fever Decision Support</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="20" cy="60" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="80" cy="40" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
            z-index: 1;
        }
        .results-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 32px;
            box-shadow: var(--shadow-xl);
            margin: 2rem auto;
            max-width: 1200px;
            position: relative;
            z-index: 10;
        }
        
        .results-header {
            background: var(--primary-gradient);
            color: white;
            border-radius: 32px 32px 0 0;
            padding: 3rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .results-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            50% { transform: translate(-50%, -50%) rotate(180deg); }
        }
        
        .results-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }
        
        .results-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        .diagnosis-card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 3rem 2rem;
            margin: 2rem 0;
            text-align: center;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .diagnosis-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }
        
        .diagnosis-card:hover::before {
            opacity: 1;
        }
        
        .diagnosis-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }
        
        .diagnosis-positive {
            background: var(--danger-gradient);
            color: white;
            border: 1px solid rgba(250, 112, 154, 0.3);
        }
        
        .diagnosis-negative {
            background: var(--success-gradient);
            color: white;
            border: 1px solid rgba(79, 172, 254, 0.3);
        }
        
        .diagnosis-card h2 {
            font-weight: 800;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }
        
        .diagnosis-card p {
            font-size: 1.2rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }
        .risk-badge {
            font-size: 1.2rem;
            padding: 0.5rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
        }
        .risk-very-low { background: #2ecc71; color: white; }
        .risk-low { background: #f39c12; color: white; }
        .risk-moderate { background: #e67e22; color: white; }
        .risk-high { background: #e74c3c; color: white; }
        .risk-very-high { background: #8e44ad; color: white; }
        
        .uncertainty-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .patient-info {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            color: white;
            position: relative;
        }
        
        .patient-info h4 {
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin-bottom: 1.5rem;
        }
        
        .patient-info p {
            font-weight: 500;
            margin-bottom: 0.75rem;
        }
        
        .medical-advice {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-left: 4px solid rgba(79, 172, 254, 0.8);
            padding: 2rem;
            margin: 2rem 0;
            border-radius: 20px;
            color: white;
        }
        
        .medical-advice h5, .medical-advice h6 {
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .card-header {
            background: var(--glass-bg) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            border-radius: 20px 20px 0 0 !important;
            color: white !important;
        }
        
        .card-body {
            color: white;
        }
        
        .alert {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            color: white;
        }
        
        .btn {
            border-radius: 50px;
            font-weight: 600;
            padding: 12px 30px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: var(--success-gradient);
            border: none;
        }
        
        .btn-secondary {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="results-container">
            <!-- Header -->
            <div class="results-header">
                <h1><i class="fas fa-brain me-3"></i>Hybrid GNN Analysis Results</h1>
                <p class="mb-0">Graph Neural Network Medical Diagnosis System</p>
            </div>

            <div class="p-4">
                <!-- Patient Information -->
                <div class="patient-info">
                    <h4><i class="fas fa-user me-2"></i>Patient Information</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Patient ID:</strong> {{ patient_data.get('patient_id', 'N/A') }}</p>
                            <p><strong>Age:</strong> {{ patient_data.get('age', 'N/A') }} years</p>
                            <p><strong>Sex:</strong> 
                                {% if patient_data.get('sex') == '1' or patient_data.get('sex') == 1 %}
                                    Male
                                {% elif patient_data.get('sex') == '0' or patient_data.get('sex') == 0 %}
                                    Female
                                {% else %}
                                    {{ patient_data.get('sex', 'N/A') }}
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Assessment Date:</strong> 
                                {% if result.get('timestamp') %}
                                    {{ result.get('timestamp') }}
                                {% else %}
                                    {{ moment().format('MMMM Do YYYY, h:mm A') if moment else 'Current Assessment' }}
                                {% endif %}
                            </p>
                            <p><strong>Temperature:</strong> {{ patient_data.get('temperature', 'N/A') }}Â°C</p>
                            <p><strong>Area Type:</strong> {{ patient_data.get('area_type', 'N/A') }}</p>
                        </div>
                    </div>
                </div>

                <!-- Main Diagnosis -->
                <div class="diagnosis-card {% if result.prediction == 1 %}diagnosis-positive{% else %}diagnosis-negative{% endif %}">
                    <h2><i class="fas fa-diagnoses me-3"></i>
                        {% if result.prediction == 1 %}
                            POSITIVE for Lassa Fever
                        {% else %}
                            NEGATIVE for Lassa Fever
                        {% endif %}
                    </h2>
                    <p class="mb-3">Confidence: {{ "%.1f"|format(result.confidence * 100) }}%</p>
                    <span class="risk-badge risk-{{ result.risk_level.lower().replace(' ', '-') }}">
                        Risk Level: {{ result.risk_level }}
                    </span>
                </div>

                <!-- Uncertainty Warning -->
                {% if result.uncertainty_warning %}
                <div class="uncertainty-warning">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Uncertainty Detected</h5>
                    <p class="mb-0">{{ result.uncertainty_warning }}</p>
                </div>
                {% endif %}

                <!-- Medical Advice -->
                <div class="medical-advice">
                    <h5><i class="fas fa-user-md me-2"></i>Medical Recommendations</h5>
                    
                    <!-- Risk Assessment Summary -->
                    <div class="alert alert-info mb-3">
                        <h6><i class="fas fa-info-circle me-2"></i>Clinical Assessment Summary</h6>
                        <p class="mb-2">
                            <strong>Diagnosis:</strong> 
                            {% if result.prediction == 1 %}
                                <span class="text-danger">POSITIVE for Lassa Fever</span> - Immediate medical attention required
                            {% else %}
                                <span class="text-success">NEGATIVE for Lassa Fever</span> - Continue monitoring symptoms
                            {% endif %}
                        </p>
                        <p class="mb-2">
                            <strong>Confidence Level:</strong> {{ "%.1f"|format(result.confidence * 100) }}% 
                            {% if result.confidence < 0.7 %}
                                <small class="text-warning">(Moderate confidence - consider additional testing)</small>
                            {% elif result.confidence >= 0.9 %}
                                <small class="text-success">(High confidence)</small>
                            {% endif %}
                        </p>
                        <p class="mb-0">
                            <strong>Risk Category:</strong> 
                            <span class="badge risk-{{ result.risk_level.lower().replace(' ', '-') }}">{{ result.risk_level }}</span>
                        </p>
                    </div>

                    <!-- Detailed Recommendations -->
                    <div class="recommendations-content">
                        <h6><i class="fas fa-clipboard-list me-2"></i>Immediate Actions Required</h6>
                        
                        {% if result.prediction == 1 %}
                            <!-- Positive Case Recommendations -->
                            <div class="alert alert-danger">
                                <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>URGENT - Positive Lassa Fever Result</h6>
                                <ul class="mb-0">
                                    <li><strong>Immediate isolation</strong> of the patient</li>
                                    <li><strong>Contact healthcare authorities</strong> immediately</li>
                                    <li><strong>Laboratory confirmation</strong> with RT-PCR testing</li>
                                    <li><strong>Start supportive care</strong> and consider Ribavirin therapy</li>
                                    <li><strong>Contact tracing</strong> for recent exposures</li>
                                </ul>
                            </div>
                        {% else %}
                            <!-- Negative Case Recommendations -->
                            <div class="alert alert-success">
                                <h6 class="alert-heading"><i class="fas fa-check-circle me-2"></i>Negative Result - Continue Monitoring</h6>
                                <ul class="mb-0">
                                    <li><strong>Monitor symptoms</strong> closely for 21 days</li>
                                    <li><strong>Seek medical attention</strong> if symptoms worsen</li>
                                    <li><strong>Maintain good hygiene</strong> practices</li>
                                    <li><strong>Avoid contact</strong> with rodents and their excreta</li>
                                </ul>
                            </div>
                        {% endif %}

                        <!-- Risk-specific recommendations -->
                        {% if result.risk_level in ['HIGH', 'VERY HIGH'] %}
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-shield-alt me-2"></i>High Risk Patient - Enhanced Monitoring</h6>
                            <ul class="mb-0">
                                <li><strong>Daily temperature monitoring</strong></li>
                                <li><strong>Watch for bleeding symptoms</strong> (gums, nose, etc.)</li>
                                <li><strong>Monitor for neurological symptoms</strong></li>
                                <li><strong>Ensure rapid access to healthcare</strong></li>
                            </ul>
                        </div>
                        {% endif %}

                        <!-- Uncertainty warning if present -->
                        {% if result.uncertainty_warning %}
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-question-circle me-2"></i>Assessment Uncertainty</h6>
                            <p>{{ result.uncertainty_warning }}</p>
                            <p class="mb-0"><strong>Recommendation:</strong> Gather additional epidemiological information and consider higher vigilance due to missing data.</p>
                        </div>
                        {% endif %}

                        <!-- Original AI advice if available -->
                        {% if result.medical_advice %}
                        <div class="mt-3">
                            <h6><i class="fas fa-project-diagram me-2"></i>Hybrid GNN Analysis</h6>
                            <div class="border-start border-primary ps-3">
                                <p><strong>Graph Construction:</strong> Patient data was embedded into a similarity graph with clinical features as nodes and relationships based on symptom patterns.</p>
                                <p><strong>GCN Analysis:</strong> Graph Convolutional Network captured local neighborhood patterns in the patient similarity space.</p>
                                <p><strong>GAT Processing:</strong> Graph Attention Network applied multi-head attention to weight important clinical features.</p>
                                <p><strong>Fusion Result:</strong> Hybrid model combined GCN and GAT outputs with uncertainty quantification for final diagnosis.</p>
                                {% if result.medical_advice %}
                                <div class="mt-2">
                                    <strong>Additional Analysis:</strong> {{ result.medical_advice|safe }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Symptoms Summary -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6><i class="fas fa-thermometer-half me-2"></i>Symptoms Present</h6>
                            </div>
                            <div class="card-body">
                                {% set symptoms = [] %}
                                {% if patient_data.get('fever_new') == '1' or patient_data.get('fever_new') == 1 %}{% set _ = symptoms.append('Fever') %}{% endif %}
                                {% if patient_data.get('headache_new') == '1' or patient_data.get('headache_new') == 1 %}{% set _ = symptoms.append('Headache') %}{% endif %}
                                {% if patient_data.get('vomiting_new') == '1' or patient_data.get('vomiting_new') == 1 %}{% set _ = symptoms.append('Vomiting') %}{% endif %}
                                {% if patient_data.get('bleeding_new') == '1' or patient_data.get('bleeding_new') == 1 %}{% set _ = symptoms.append('Bleeding') %}{% endif %}
                                {% if patient_data.get('weakness_new') == '1' or patient_data.get('weakness_new') == 1 %}{% set _ = symptoms.append('Weakness') %}{% endif %}
                                {% if patient_data.get('abdominal_pain') == '1' or patient_data.get('abdominal_pain') == 1 %}{% set _ = symptoms.append('Abdominal Pain') %}{% endif %}
                                {% if patient_data.get('diarrhea_new') == '1' or patient_data.get('diarrhea_new') == 1 %}{% set _ = symptoms.append('Diarrhea') %}{% endif %}
                                {% if patient_data.get('sore_throat') == '1' or patient_data.get('sore_throat') == 1 %}{% set _ = symptoms.append('Sore Throat') %}{% endif %}
                                {% if patient_data.get('cough_new') == '1' or patient_data.get('cough_new') == 1 %}{% set _ = symptoms.append('Cough') %}{% endif %}
                                {% if patient_data.get('backache_new') == '1' or patient_data.get('backache_new') == 1 %}{% set _ = symptoms.append('Back Pain') %}{% endif %}
                                {% if patient_data.get('chest_pain') == '1' or patient_data.get('chest_pain') == 1 %}{% set _ = symptoms.append('Chest Pain') %}{% endif %}
                                {% if patient_data.get('difficulty_breathing') == '1' or patient_data.get('difficulty_breathing') == 1 %}{% set _ = symptoms.append('Difficulty Breathing') %}{% endif %}
                                {% if patient_data.get('fatigue_weakness') == '1' or patient_data.get('fatigue_weakness') == 1 %}{% set _ = symptoms.append('Fatigue') %}{% endif %}
                                {% if patient_data.get('joint_pain_arthritis') == '1' or patient_data.get('joint_pain_arthritis') == 1 %}{% set _ = symptoms.append('Joint Pain') %}{% endif %}
                                {% if patient_data.get('muscle_pain') == '1' or patient_data.get('muscle_pain') == 1 %}{% set _ = symptoms.append('Muscle Pain') %}{% endif %}
                                {% if patient_data.get('nausea_new') == '1' or patient_data.get('nausea_new') == 1 %}{% set _ = symptoms.append('Nausea') %}{% endif %}
                                
                                {% if symptoms %}
                                    <ul class="list-unstyled">
                                        {% for symptom in symptoms %}
                                        <li><i class="fas fa-check text-danger me-2"></i>{{ symptom }}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-muted">No major symptoms reported</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-warning text-white">
                                <h6><i class="fas fa-globe-africa me-2"></i>Risk Factors</h6>
                            </div>
                            <div class="card-body">
                                {% set risk_factors = [] %}
                                {% if patient_data.get('contact_history') == '1' or patient_data.get('contact_history') == 1 %}{% set _ = risk_factors.append('Contact with Lassa Case') %}{% endif %}
                                {% if patient_data.get('travel_history') == '1' or patient_data.get('travel_history') == 1 %}{% set _ = risk_factors.append('Travel to Endemic Area') %}{% endif %}
                                {% if patient_data.get('rodent_exposure') == '1' or patient_data.get('rodent_exposure') == 1 %}{% set _ = risk_factors.append('Rodent Exposure') %}{% endif %}
                                
                                <!-- Also check for "I don't know" values and display them -->
                                {% if patient_data.get('contact_history') == '-1' or patient_data.get('contact_history') == -1 %}{% set _ = risk_factors.append('Contact with Lassa Case (Unknown)') %}{% endif %}
                                {% if patient_data.get('travel_history') == '-1' or patient_data.get('travel_history') == -1 %}{% set _ = risk_factors.append('Travel to Endemic Area (Unknown)') %}{% endif %}
                                {% if patient_data.get('rodent_exposure') == '-1' or patient_data.get('rodent_exposure') == -1 %}{% set _ = risk_factors.append('Rodent Exposure (Unknown)') %}{% endif %}
                                
                                {% if risk_factors %}
                                    <ul class="list-unstyled">
                                        {% for factor in risk_factors %}
                                        <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>{{ factor }}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-muted">No known risk factors</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="text-center mt-4">
                    <a href="{{ url_for('predict_form') }}" class="btn btn-primary btn-lg me-3">
                        <i class="fas fa-plus me-2"></i>New Assessment
                    </a>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-chart-bar me-2"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
